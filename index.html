<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>AgtronCam Ultra — Pro UI</title>
  <meta name="description" content="Estimator level roasting kopi (mendekati skala Agtron) via kamera HP. Pro UI: tata letak profesional, light theme, PWA." />
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --bg:#f8fafc; --card:#ffffff; --border:#e5e7eb; --text:#0f172a; --muted:#475569; --accent:#0ea5e9; --accent-2:#10b981; }
    body{ background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .container{ max-width:1200px; margin:0 auto; padding:1rem; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:1rem; box-shadow: 0 10px 20px rgba(2,8,23,.04); }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.7rem 1rem; border-radius:.8rem; background:var(--text); color:white; border:1px solid rgba(2,8,23,.06); font-weight:700; }
    .btn.secondary{ background:white; color:var(--text); border:1px solid var(--border); }
    .btn.ghost{ background:transparent; border:1px dashed var(--border); color:#0369a1; }
    .badge{ padding:.2rem .6rem; border-radius:9999px; font-weight:800; color:white; background:var(--accent-2); }
    .meter{ height:.6rem; background:#eef2f7; border-radius:.5rem; overflow:hidden; border:1px solid var(--border); }
    .meter > div{ height:100%; width:0%; background:var(--text); transition: width .3s ease; }
    .pill{ border:1px solid var(--border); padding:.35rem .55rem; border-radius:9999px; font-size:.75rem; color:var(--muted); background:white; }
    .mono{ font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; }
    /* Camera overlay */
    .overlay{ position:relative; overflow:hidden; border-radius:.75rem; }
    .grid-bg{ background-image: linear-gradient(to right, rgba(2,8,23,.06) 1px, transparent 1px), linear-gradient(to bottom, rgba(2,8,23,.06) 1px, transparent 1px); background-size: 22px 22px; }
    #roiCircle{ position:absolute; border:2px dashed rgba(255,255,255,.95); border-radius:9999px; box-shadow:0 0 0 9999px rgba(0,0,0,.35); pointer-events:none; }
    #roiWhite{ position:absolute; border:2px dashed rgba(255,255,255,.95); background: rgba(255,255,255,.15); box-shadow:0 0 0 9999px rgba(0,0,0,.25); pointer-events:none; }
    .safe{ padding-bottom: env(safe-area-inset-bottom); }
    .step{ display:flex; align-items:center; gap:.5rem; color:#0f172a; }
    .dot{ width:26px; height:26px; border-radius:9999px; background:var(--accent); color:white; font-weight:800; display:grid; place-items:center; }
  </style>
</head>
<body class="safe">
  <div class="container">
    <!-- Header -->
    <header class="mb-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="/brand/logo.png" class="h-10 w-auto" alt="logo"/>
          <div>
            <h1 class="text-2xl font-extrabold tracking-tight">AgtronCam <span class="text-sky-500">Ultra</span> · <span class="text-emerald-500">Pro UI</span></h1>
            <p class="text-sm text-slate-500 -mt-0.5">Estimator roasting kopi — multi-point calibration • Import/Export model • PWA</p>
          </div>
        </div>
        <div class="text-xs text-slate-500 font-semibold">Powered by <span class="text-sky-600">MUKEMEN.AI</span> · <span class="text-emerald-600">FABARO GROUP</span></div>
      </div>
      <!-- Stepper -->
      <div class="mt-3 grid grid-cols-1 md:grid-cols-4 gap-2">
        <div class="card p-3">
          <div class="step"><span class="dot">1</span><b>Siapkan Sampel</b></div>
          <p class="text-xs text-slate-500 mt-1">Bubuk kopi di tengah lingkaran. Kertas putih/grey card di kotak kanan-atas.</p>
        </div>
        <div class="card p-3">
          <div class="step"><span class="dot">2</span><b>Mulai & Kalibrasi</b></div>
          <p class="text-xs text-slate-500 mt-1">Mulai kamera → Kalibrasi Putih (opsional: Optimasi Grey Card).</p>
        </div>
        <div class="card p-3">
          <div class="step"><span class="dot">3</span><b>Ukur & Cek Kualitas</b></div>
          <p class="text-xs text-slate-500 mt-1">Pastikan gate lolos: glare rendah, WB Δ kecil, stabil.</p>
        </div>
        <div class="card p-3">
          <div class="step"><span class="dot">4</span><b>Kalibrasi Multi-Titik</b></div>
          <p class="text-xs text-slate-500 mt-1">Isi nilai Agtron referensi → Tambah beberapa titik → Fit Polinomial.</p>
        </div>
      </div>
    </header>

    <!-- Main grid -->
    <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Camera panel -->
      <section class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <h2 class="font-semibold">Kamera & Area Sampel</h2>
            <span class="pill">Mode:
              <select id="mode" class="bg-transparent outline-none">
                <option value="ground">Ground</option>
                <option value="bean">Whole Bean</option>
              </select>
            </span>
          </div>
          <div class="flex gap-2">
            <button id="btnStart" class="btn">Mulai Kamera</button>
            <button id="btnPause" class="btn secondary">Jeda</button>
            <button id="btnSnap" class="btn ghost">Snapshot</button>
          </div>
        </div>

        <div class="overlay bg-black grid-bg">
          <video id="video" playsinline autoplay muted class="w-full h-[52vh] object-cover"></video>
          <canvas id="canvas" class="hidden"></canvas>
          <div id="roiCircle"></div>
          <div id="roiWhite"></div>
        </div>

        <div class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-2">
          <button id="btnCalib" class="btn secondary">Kalibrasi Putih</button>
          <button id="btnGrayCard" class="btn secondary">Optimasi Gray Card</button>
          <button id="btnMeasure" class="btn">Ukur (Avg)</button>
          <button id="btnSave" class="btn secondary">Simpan</button>
          <button id="btnReset" class="btn secondary">Reset</button>
          <button id="btnInstall" class="btn secondary">Install App</button>
        </div>
      </section>

      <!-- Results panel -->
      <section class="card p-4">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Hasil & Kalibrasi</h2>
          <div class="flex items-center gap-2">
            <span class="pill">Skema:
              <select id="scheme" class="bg-transparent outline-none">
                <option value="gourmet">Gourmet</option>
                <option value="commercial">Commercial</option>
                <option value="custom">Custom</option>
              </select>
            </span>
            <button id="btnExportCSV" class="btn secondary">Export CSV</button>
            <button id="btnExportModel" class="btn ghost">Export Model</button>
            <label class="btn ghost cursor-pointer">Import Model
              <input id="importModel" type="file" accept="application/json" class="hidden"/>
            </label>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-3">
          <div class="p-3 rounded-lg border border-slate-200">
            <div class="text-sm text-slate-500">Agtron (estimasi)</div>
            <div class="text-3xl font-extrabold mono"><span id="agtron">--</span></div>
            <div class="mt-2 flex items-center gap-2">
              <span id="badge" class="badge">—</span>
              <span id="desc" class="text-sm text-slate-600"></span>
            </div>
            <div class="mt-3">
              <div class="meter"><div id="agtronBar"></div></div>
              <div class="flex justify-between text-xs text-slate-400 mt-1"><span>Very Dark</span><span>Very Light</span></div>
            </div>
          </div>

          <div class="p-3 rounded-lg border border-slate-200">
            <div class="text-sm text-slate-500">CIELAB</div>
            <div class="mono text-xl font-semibold"><span id="L">--</span> / <span id="a">--</span> / <span id="b">--</span></div>
            <div class="text-xs text-slate-500">L* terang, a* hijau→merah, b* biru→kuning</div>
          </div>

          <div class="p-3 rounded-lg border border-slate-200">
            <div class="text-sm text-slate-500 mb-1">Kalibrasi</div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="text-xs">Scale</label>
                <input id="scale" type="range" min="0.4" max="2.4" step="0.01" class="w-full" />
                <div class="mono text-right text-xs" id="scaleVal">1.20</div>
              </div>
              <div>
                <label class="text-xs">Offset</label>
                <input id="offset" type="range" min="-40" max="50" step="0.5" class="w-full" />
                <div class="mono text-right text-xs" id="offsetVal">10.0</div>
              </div>
            </div>
            <div class="mt-2 p-2 rounded border border-slate-200">
              <div class="text-xs font-semibold mb-2">Multi-Point Fit</div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-start">
                <div>
                  <input id="refVal" type="number" step="0.1" class="w-full border rounded px-2 py-1" placeholder="Agtron referensi" />
                  <button id="capPoint" class="btn secondary w-full mt-1 text-xs">Tambah Kalibrasi</button>
                </div>
                <div class="md:col-span-2 text-xs text-slate-500">
                  <div>Points: <span id="ptsCount">0</span> • Model: <span id="modelInfo">Linear</span></div>
                  <div class="mt-1 flex flex-wrap gap-2">
                    <button id="fitLinear" class="btn ghost text-xs">Fit Linear</button>
                    <button id="fitPoly" class="btn ghost text-xs">Fit Polinomial</button>
                    <button id="clearPts" class="btn ghost text-xs">Clear Points</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="p-3 rounded-lg border border-slate-200">
            <div class="text-sm text-slate-500">Kualitas & Gate</div>
            <div class="text-sm mt-1">
              <div>Glare: <span id="glare" class="mono">--</span>%</div>
              <div>WB ΔRGB: <span id="wbErr" class="mono">--</span></div>
              <div>Stabilitas (EMA): <span id="stability" class="mono">--</span></div>
            </div>
            <div class="mt-2">
              <div class="text-xs text-slate-500 mb-1">Ready Score</div>
              <div class="meter"><div id="readyBar"></div></div>
            </div>
            <div class="flex gap-2 mt-2 items-center">
              <label class="text-xs">Gate</label>
              <select id="gate" class="border rounded px-2 py-1 text-xs">
                <option value="loose">Loose</option>
                <option value="normal" selected>Normal</option>
                <option value="strict">Strict</option>
              </select>
              <span id="gateMsg" class="text-xs text-amber-600"></span>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="mt-6 text-center text-xs text-slate-500">
      © <span id="year"></span> AgtronCam Ultra · Pro UI — Untuk QC resmi, gunakan alat profesional.
    </footer>
  </div>

  <script src="/app.js"></script>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js'));
  </script>
</body>
</html>
